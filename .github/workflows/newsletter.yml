name: Events Industry Newsletter (with Approval)

on:
  schedule:
    - cron: '0 7 * * 1'
  
  workflow_dispatch:
    inputs:
      days_back:
        description: 'Days to look back'
        required: false
        default: '7'
        type: choice
        options: ['3', '7', '14', '21', '30']
      
      stories_per_section:
        description: 'Stories per section'
        required: false
        default: '3'
        type: choice
        options: ['2', '3', '4', '5']
      
      newsletter_title:
        description: 'Newsletter title'
        required: false
        default: 'Events Industry Intelligence'
      
      custom_instructions:
        description: 'Editorial instructions for Claude'
        required: false
        default: ''
      
      focus_section:
        description: 'Section to emphasize'
        required: false
        default: 'all'
        type: choice
        options: ['all', 'market_signals', 'deals', 'hires_fires']
      
      regenerate_feedback:
        description: 'If regenerating - what to change'
        required: false
        default: ''

jobs:
  generate-draft:
    runs-on: ubuntu-latest
    outputs:
      run_number: ${{ github.run_number }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: pip install anthropic feedparser requests python-dateutil jinja2 beautifulsoup4
      
      - name: Check for user sources
        id: check_sources
        run: |
          if [ -d "sources" ] && [ "$(ls -A sources 2>/dev/null)" ]; then
            echo "sources_exist=true" >> $GITHUB_OUTPUT
          else
            echo "sources_exist=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Generate newsletter
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          EXTRA_PROMPT: "${{ github.event.inputs.custom_instructions }} ${{ github.event.inputs.regenerate_feedback }}"
        run: |
          SOURCES_ARG=""
          if [ "${{ steps.check_sources.outputs.sources_exist }}" = "true" ]; then
            SOURCES_ARG="--sources-folder ./sources"
          fi
          
          python events_newsletter_generator.py \
            --days ${{ github.event.inputs.days_back || '7' }} \
            --stories ${{ github.event.inputs.stories_per_section || '3' }} \
            --title "${{ github.event.inputs.newsletter_title || 'Events Industry Intelligence' }}" \
            --output html \
            --out-file newsletter.html \
            $SOURCES_ARG
          
          python events_newsletter_generator.py \
            --days ${{ github.event.inputs.days_back || '7' }} \
            --stories ${{ github.event.inputs.stories_per_section || '3' }} \
            --title "${{ github.event.inputs.newsletter_title || 'Events Industry Intelligence' }}" \
            --output markdown \
            --out-file newsletter.md \
            $SOURCES_ARG
      
      - name: Upload draft
        uses: actions/upload-artifact@v4
        with:
          name: newsletter-draft-${{ github.run_number }}
          path: |
            newsletter.html
            newsletter.md
          retention-days: 14
      
      - name: Post preview
        run: |
          echo "## ðŸ“° Newsletter Draft Ready" >> $GITHUB_STEP_SUMMARY
          echo "Download the artifact above to review." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Preview:" >> $GITHUB_STEP_SUMMARY
          head -80 newsletter.md >> $GITHUB_STEP_SUMMARY

  wait-for-approval:
    runs-on: ubuntu-latest
    needs: generate-draft
    environment:
      name: newsletter-approval
    steps:
      - name: Approved
        run: echo "Newsletter approved!"

  publish:
    runs-on: ubuntu-latest
    needs: [generate-draft, wait-for-approval]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Download newsletter
        uses: actions/download-artifact@v4
        with:
          name: newsletter-draft-${{ needs.generate-draft.outputs.run_number || github.run_number }}
          path: ./approved
      
      - name: Publish to repository
        run: |
          mkdir -p newsletters
          DATE=$(date +%Y-%m-%d)
          cp ./approved/newsletter.html newsletters/${DATE}.html
          cp ./approved/newsletter.md newsletters/${DATE}.md
          cp ./approved/newsletter.html newsletters/latest.html
          cp ./approved/newsletter.md newsletters/latest.md
          git config user.email "action@github.com"
          git config user.name "GitHub Action"
          git add newsletters/
          git commit -m "Newsletter ${DATE}" || echo "No changes"
          git push
          
          echo "## Published!" >> $GITHUB_STEP_SUMMARY

name: Events Industry Newsletter (with Approval)

on:
  schedule:
    # Every Monday at 7:00 AM UTC
    - cron: '0 7 * * 1'
  
  workflow_dispatch:
    inputs:
      days_back:
        description: 'Days to look back'
        required: false
        default: '7'
        type: choice
        options: ['3', '7', '14', '21', '30']
      
      stories_per_section:
        description: 'Stories per section'
        required: false
        default: '3'
        type: choice
        options: ['2', '3', '4', '5']
      
      newsletter_title:
        description: 'Newsletter title'
        required: false
        default: 'Events Industry Intelligence'
      
      custom_instructions:
        description: 'Editorial instructions for Claude'
        required: false
        default: ''
        type: string
      
      focus_section:
        description: 'Section to emphasize (or "all")'
        required: false
        default: 'all'
        type: choice
        options:
          - 'all'
          - 'market_signals'
          - 'deals'
          - 'hires_fires'
      
      regenerate_feedback:
        description: 'If regenerating - what to change'
        required: false
        default: ''
        type: string

jobs:
  # ===========================================
  # JOB 1: Generate newsletter draft
  # ===========================================
  generate-draft:
    runs-on: ubuntu-latest
    outputs:
      run_number: ${{ github.run_number }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: pip install anthropic feedparser requests python-dateutil jinja2 beautifulsoup4
      
      - name: Show parameters
        run: |
          echo "## ðŸ”§ Generation Parameters" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Setting | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Days back | ${{ github.event.inputs.days_back || '7' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Stories per section | ${{ github.event.inputs.stories_per_section || '3' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Title | ${{ github.event.inputs.newsletter_title || 'Events Industry Intelligence' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Focus | ${{ github.event.inputs.focus_section || 'all' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Custom instructions | ${{ github.event.inputs.custom_instructions || '(none)' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Regenerate feedback | ${{ github.event.inputs.regenerate_feedback || '(none)' }} |" >> $GITHUB_STEP_SUMMARY
      
      - name: Check for user sources
        id: check_sources
        run: |
          if [ -d "sources" ] && [ "$(ls -A sources 2>/dev/null)" ]; then
            echo "sources_exist=true" >> $GITHUB_OUTPUT
            echo "ðŸ“ Found user sources folder with content" >> $GITHUB_STEP_SUMMARY
            ls -la sources/ >> $GITHUB_STEP_SUMMARY
          else
            echo "sources_exist=false" >> $GITHUB_OUTPUT
            echo "ðŸ“ No user sources folder (will use RSS only)" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Generate newsletter
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          EXTRA_PROMPT: |
            ${{ github.event.inputs.custom_instructions }}
            ${{ github.event.inputs.regenerate_feedback }}
            ${{ github.event.inputs.focus_section != 'all' && format('Focus especially on the {0} section - make it more comprehensive.', github.event.inputs.focus_section) || '' }}
        run: |
          SOURCES_ARG=""
          if [ "${{ steps.check_sources.outputs.sources_exist }}" = "true" ]; then
            SOURCES_ARG="--sources-folder ./sources"
          fi
          
          python events_newsletter_generator.py \
            --days ${{ github.event.inputs.days_back || '7' }} \
            --stories ${{ github.event.inputs.stories_per_section || '3' }} \
            --title "${{ github.event.inputs.newsletter_title || 'Events Industry Intelligence' }}" \
            --output html \
            --out-file newsletter.html \
            $SOURCES_ARG
          
          python events_newsletter_generator.py \
            --days ${{ github.event.inputs.days_back || '7' }} \
            --stories ${{ github.event.inputs.stories_per_section || '3' }} \
            --title "${{ github.event.inputs.newsletter_title || 'Events Industry Intelligence' }}" \
            --output markdown \
            --out-file newsletter.md \
            $SOURCES_ARG
      
      - name: Upload draft
        uses: actions/upload-artifact@v4
        with:
          name: newsletter-draft-${{ github.run_number }}
          path: |
            newsletter.html
            newsletter.md
          retention-days: 14
      
      - name: Post review instructions
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“° Newsletter Draft Ready for Review" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Review Steps:" >> $GITHUB_STEP_SUMMARY
          echo "1. **Download** artifact \`newsletter-draft-${{ github.run_number }}\`" >> $GITHUB_STEP_SUMMARY
          echo "2. **Open** \`newsletter.html\` in browser" >> $GITHUB_STEP_SUMMARY
          echo "3. **Review** each section:" >> $GITHUB_STEP_SUMMARY
          echo "   - ðŸ“Š Market Signals - strategic trends" >> $GITHUB_STEP_SUMMARY
          echo "   - ðŸ¤ Deals - M&A activity" >> $GITHUB_STEP_SUMMARY
          echo "   - ðŸ‘” Hires & Fires - executive moves" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Then either:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… **Approve** â†’ Click review button below" >> $GITHUB_STEP_SUMMARY
          echo "- âœï¸ **Request changes** â†’ Reject, then re-run with feedback" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "### Quick Preview:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          head -80 newsletter.md >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "... (download full version)" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  # ===========================================
  # JOB 2: Wait for approval
  # ===========================================
  wait-for-approval:
    runs-on: ubuntu-latest
    needs: genera

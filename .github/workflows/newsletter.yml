name: The Second Curves Brief (with Review)

on:
  schedule:
    # Weekly: Every Monday at 7:00 AM UTC
    - cron: '0 7 * * 1'
  
  workflow_dispatch:
    inputs:
      days_back:
        description: 'Days to look back'
        required: false
        default: '7'
        type: choice
        options: ['3', '7', '14', '21', '30']
      
      stories_per_section:
        description: 'Stories per section'
        required: false
        default: '3'
        type: choice
        options: ['2', '3', '4', '5']
      
      recipient_name:
        description: 'Recipient name (for "Good morning, [NAME]")'
        required: false
        default: 'Reader'
      
      custom_instructions:
        description: 'Editorial instructions'
        required: false
        default: ''
      
      include_articles:
        description: 'Article numbers to include (e.g., "3,7,12")'
        required: false
        default: ''
      
      exclude_articles:
        description: 'Article numbers to exclude (e.g., "5,9")'
        required: false
        default: ''
      
      regenerate_feedback:
        description: 'Feedback from previous draft'
        required: false
        default: ''

jobs:
  # ===========================================
  # JOB 1: Fetch articles and show list
  # ===========================================
  fetch-articles:
    runs-on: ubuntu-latest
    outputs:
      has_articles: ${{ steps.fetch.outputs.has_articles }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: pip install anthropic feedparser requests python-dateutil jinja2 beautifulsoup4
      
      - name: Fetch and list articles
        id: fetch
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          SOURCES_ARG=""
          if [ -d "sources" ]; then
            SOURCES_ARG="--sources-folder ./sources"
          fi
          
          python events_newsletter_generator.py \
            --days ${{ github.event.inputs.days_back || '7' }} \
            --list-articles \
            $SOURCES_ARG > article_list.txt
          
          if [ -s article_list.txt ]; then
            echo "has_articles=true" >> $GITHUB_OUTPUT
          else
            echo "has_articles=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Upload article list
        uses: actions/upload-artifact@v4
        with:
          name: article-list
          path: article_list.txt
          retention-days: 7
      
      - name: Show article list in summary
        run: |
          echo "## ðŸ“‹ Available Articles for Review" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Download \`article-list\` artifact for full details, or see preview below:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          head -100 article_list.txt >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ’¡ To customize article selection:" >> $GITHUB_STEP_SUMMARY
          echo "Re-run this workflow with:" >> $GITHUB_STEP_SUMMARY
          echo "- \`include_articles\`: e.g., \"3,7,12\" to prioritize specific articles" >> $GITHUB_STEP_SUMMARY
          echo "- \`exclude_articles\`: e.g., \"5,9\" to skip specific articles" >> $GITHUB_STEP_SUMMARY

  # ===========================================
  # JOB 2: Generate newsletter draft
  # ===========================================
  generate-draft:
    runs-on: ubuntu-latest
    needs: fetch-articles
    if: needs.fetch-articles.outputs.has_articles == 'true'
    outputs:
      run_number: ${{ github.run_number }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: pip install anthropic feedparser requests python-dateutil jinja2 beautifulsoup4
      
      - name: Generate newsletter
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          EXTRA_PROMPT: "${{ github.event.inputs.custom_instructions }} ${{ github.event.inputs.regenerate_feedback }}"
        run: |
          SOURCES_ARG=""
          if [ -d "sources" ]; then
            SOURCES_ARG="--sources-folder ./sources"
          fi
          
          INCLUDE_ARG=""
          if [ -n "${{ github.event.inputs.include_articles }}" ]; then
            INCLUDE_ARG="--include ${{ github.event.inputs.include_articles }}"
          fi
          
          EXCLUDE_ARG=""
          if [ -n "${{ github.event.inputs.exclude_articles }}" ]; then
            EXCLUDE_ARG="--exclude ${{ github.event.inputs.exclude_articles }}"
          fi
          
          python events_newsletter_generator.py \
            --days ${{ github.event.inputs.days_back || '7' }} \
            --stories ${{ github.event.inputs.stories_per_section || '3' }} \
            --recipient "${{ github.event.inputs.recipient_name || 'Reader' }}" \
            --output html \
            --out-file newsletter.html \
            $SOURCES_ARG $INCLUDE_ARG $EXCLUDE_ARG
          
          python events_newsletter_generator.py \
            --days ${{ github.event.inputs.days_back || '7' }} \
            --stories ${{ github.event.inputs.stories_per_section || '3' }} \
            --recipient "${{ github.event.inputs.recipient_name || 'Reader' }}" \
            --output markdown \
            --out-file newsletter.md \
            $SOURCES_ARG $INCLUDE_ARG $EXCLUDE_ARG
      
      - name: Upload draft
        uses: actions/upload-artifact@v4
        with:
          name: newsletter-draft-${{ github.run_number }}
          path: |
            newsletter.html
            newsletter.md
          retention-days: 14
      
      - name: Show preview
        run: |
          echo "## ðŸ“° Newsletter Draft Ready" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Review Steps:" >> $GITHUB_STEP_SUMMARY
          echo "1. Download \`newsletter-draft-${{ github.run_number }}\` artifact" >> $GITHUB_STEP_SUMMARY
          echo "2. Open \`newsletter.html\` in your browser" >> $GITHUB_STEP_SUMMARY
          echo "3. Check the executive summary and each section" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Then:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… **Approve** â†’ Click review button below" >> $GITHUB_STEP_SUMMARY
          echo "- âœï¸ **Request changes** â†’ Reject, then re-run with feedback" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "### Preview (Markdown):" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          head -120 newsletter.md >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "... [download full version]" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  # ===========================================
  # JOB 3: Wait for approval
  # ===========================================
  wait-for-approval:
    runs-on: ubuntu-latest
    needs: generate-draft
    environment:
      name: newsletter-approval
    steps:
      - name: Approved
        run: echo "âœ… Newsletter approved!"

  # ===========================================
  # JOB 4: Publish
  # ===========================================
  publish:
    runs-on: ubuntu-latest
    needs: [generate-draft, wait-for-approval]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Download newsletter
        uses: actions/download-artifact@v4
        with:
          name: newsletter-draft-${{ needs.generate-draft.outputs.run_number || github.run_number }}
          path: ./approved
      
      - name: Publish
        run: |
          mkdir -p newsletters
          DATE=$(date +%Y-%m-%d)
          
          cp ./approved/newsletter.html newsletters/${DATE}.html
          cp ./approved/newsletter.md newsletters/${DATE}.md
          cp ./approved/newsletter.html newsletters/latest.html
          cp ./approved/newsletter.md newsletters/latest.md
          
          git config user.email "action@github.com"
          git config user.name "GitHub Action"
          git add newsletters/
          git commit -m "ðŸ“° Newsletter ${DATE}" || echo "No changes"
          git push
          
          echo "## âœ… Published!" >> $GITHUB_STEP_SUMMARY
          echo "- [View latest HTML](../../blob/main/newsletters/latest.html)" >> $GITHUB_STEP_SUMMARY
